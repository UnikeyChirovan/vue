<template>
  <div class="profile-page">
    <!-- Cover Section -->
    <div class="cover-section">
      <div class="cover-container" v-show="!showChange && !showEdit">
        <img
          :src="coverUrl ? coverUrl : 'https://picsum.photos/1200/300'"
          alt="Cover Image"
          class="cover-img"
          :style="coverStyle"
        />
      </div>

      <div class="cover-change" v-if="showChange">
        <input
          type="file"
          ref="coverInput"
          @change="handleCoverUpload"
          accept="image/*"
          style="display: none"
        />
        <button @click="$refs.coverInput.click()" class="select-image-btn">
          <i class="fa-solid fa-image"></i>
          <span>Chọn hình</span>
        </button>

        <div
          class="custom-cover"
          :style="{ cursor: 'grab' }"
          @mousedown="startDrag($event, 'cover')"
          v-if="newCoverUrl"
        >
          <img
            :src="newCoverUrl"
            class="img-cover-custom"
            alt="Cover"
            :style="coverStyle"
          />
        </div>

        <div class="slider-container">
          <input
            type="range"
            v-model="coverPosition"
            min="-1000"
            max="0"
            orient="vertical"
            class="vertical-slider"
          />
        </div>
        <button @click="cancelChange" class="cancel-button">Hủy</button>
        <button @click="saveNewCover" class="save-button">Lưu</button>
      </div>

      <div class="cover-edit" v-if="showEdit">
        <div
          class="custom-cover"
          :style="{ cursor: 'grab' }"
          @mousedown="startDrag($event, 'cover')"
          v-if="coverUrl"
        >
          <img
            :src="coverUrl"
            class="img-cover-custom"
            alt="Cover"
            :style="coverStyle"
          />
        </div>
        <div class="slider-container">
          <input
            type="range"
            v-model="coverPosition"
            min="-1000"
            max="0"
            orient="vertical"
            class="vertical-slider"
          />
        </div>
        <button @click="cancelEdit" class="cancel-button">Hủy</button>
        <button @click="saveEditedCover" class="save-button">Lưu</button>
      </div>

      <div class="edit-cover-btn" v-if="authStore.user?.id === users.id">
        <div class="dropdown">
          <button class="dropdown-toggle">
            <i class="fa-solid fa-gear"></i>
          </button>
          <div class="dropdown-menu">
            <button @click="handleSelect('viewcover')" class="dropdown-item">
              <i class="fa-solid fa-eye"></i>
              <span>Coi Hình</span>
            </button>
            <button @click="handleSelect('changecover')" class="dropdown-item">
              <i class="fa-solid fa-cloud-upload-alt"></i>
              <span>Thay Hình</span>
            </button>
            <button @click="handleSelect('settingcover')" class="dropdown-item">
              <i class="fa-solid fa-pen"></i>
              <span>Sửa Hình</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Avatar Section -->
    <div class="avatar-section">
      <img
        class="avatar-img"
        alt="User Profile"
        :src="avatarUrl || 'https://picsum.photos/150'"
      />
      <button
        v-if="authStore.user?.id === users.id"
        @click="handleCameraClick"
        class="camera-btn"
      >
        <i class="fa-solid fa-camera"></i>
      </button>
    </div>

    <!-- View Cover Modal -->
    <div v-if="showViewModal" class="modal-overlay" @click="showViewModal = false">
      <div class="modal-content" @click.stop>
        <button @click="showViewModal = false" class="modal-close">
          <i class="fa-solid fa-times"></i>
        </button>
        <img :src="coverUrl" class="full-cover-img" />
      </div>
    </div>

    <!-- Profile Header -->
    <div class="profile-header-content">
      <h1 class="username-title">{{ users.name }}</h1>
      <div class="rating-stars">
        <i class="fas fa-star"></i>
        <i class="fas fa-star"></i>
        <i class="fas fa-star"></i>
        <i class="fas fa-star"></i>
        <i class="fas fa-star"></i>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons-group">
        <button class="action-btn explore-btn" @click="openExploreModal">
          <i class="fas fa-compass"></i>
          <span>Khám Phá</span>
        </button>
        <button class="action-btn list-btn" @click="openFollowingModal">
          <i class="fas fa-list"></i>
          <span>Danh Sách</span>
        </button>
        <button class="action-btn inbox-btn" @click="openChatInbox">
          <i class="fas fa-envelope"></i>
          <span>Hộp Thư</span>
          <span v-if="chatStore.totalUnreadMessages > 0" class="badge-count">
            {{ chatStore.totalUnreadMessages }}
          </span>
        </button>
      </div>
    </div>

    <!-- Profile Content Cards -->
    <div class="profile-content-wrapper">
      <!-- Personal Info Card -->
      <div class="profile-card">
        <div class="card-header-green">
          <i class="fas fa-user-circle"></i>
          <span>Thông Tin Cá Nhân</span>
        </div>
        <div class="card-body-white">
          <div class="info-row" v-if="users.occupation">
            <i class="fas fa-briefcase icon-label"></i>
            <div class="info-content">
              <strong>Nghề nghiệp:</strong>
              <span>{{ users.occupation }}</span>
            </div>
          </div>
          <div class="info-row" v-if="users.gender">
            <i class="fas fa-venus-mars icon-label"></i>
            <div class="info-content">
              <strong>Giới tính:</strong>
              <span>{{ users.gender }}</span>
            </div>
          </div>
          <div class="info-row" v-if="users.birthday">
            <i class="fas fa-birthday-cake icon-label"></i>
            <div class="info-content">
              <strong>Ngày sinh:</strong>
              <span>{{ formattedBirthday }}</span>
            </div>
          </div>
          <div class="info-row" v-if="users.address">
            <i class="fas fa-map-marker-alt icon-label"></i>
            <div class="info-content">
              <strong>Địa chỉ:</strong>
              <span>{{ users.address }}</span>
            </div>
          </div>
          <div class="info-row" v-if="users.hobbies">
            <i class="fas fa-heart icon-label"></i>
            <div class="info-content">
              <strong>Sở thích:</strong>
              <span>{{ users.hobbies }}</span>
            </div>
          </div>
          <div class="info-row" v-if="users.biography">
            <i class="fas fa-book icon-label"></i>
            <div class="info-content">
              <strong>Tiểu sử:</strong>
              <span>{{ users.biography }}</span>
            </div>
          </div>
          <div class="info-row" v-if="users.phone_number">
            <i class="fas fa-phone icon-label"></i>
            <div class="info-content">
              <strong>Điện Thoại:</strong>
              <span>{{ users.phone_number }}</span>
            </div>
          </div>
          <div class="info-row" v-if="users.email">
            <i class="fas fa-envelope icon-label"></i>
            <div class="info-content">
              <strong>Email:</strong>
              <span>{{ users.email }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Card -->
      <div class="profile-card" v-if="followStats">
        <div class="card-header-green">
          <i class="fas fa-chart-bar"></i>
          <span>Thống Kê Tài Khoản</span>
        </div>
        <div class="card-body-white">
          <div class="stats-grid-content">
            <div class="stat-circle-item">
              <div class="stat-circle purple-circle">
                <i class="fas fa-file-alt"></i>
              </div>
              <h3 class="stat-number">150</h3>
              <p class="stat-label">Bài đăng</p>
            </div>
            <div class="stat-circle-item">
              <div class="stat-circle pink-circle">
                <i class="fas fa-users"></i>
              </div>
              <h3 class="stat-number">{{ followStats.followers_count }}</h3>
              <p class="stat-label">Người theo dõi</p>
            </div>
            <div class="stat-circle-item">
              <div class="stat-circle blue-circle">
                <i class="fas fa-user-friends"></i>
              </div>
              <h3 class="stat-number">{{ followStats.following_count }}</h3>
              <p class="stat-label">Đang theo dõi</p>
            </div>
          </div>
        </div>
      </div>

      <!-- History Card -->
      <div class="profile-card">
        <div class="card-header-green">
          <i class="fas fa-history"></i>
          <span>Lịch Sử Gần Đây</span>
        </div>
        <div class="card-body-white">
          <div class="history-item-box">
            <i class="fas fa-play-circle history-icon"></i>
            <div class="history-text">
              <span>Chương đọc gần nhất:</span>
              <strong class="history-number">{{ lastChapter - 1 }}</strong>
            </div>
          </div>
          <div class="history-item-box">
            <i class="fas fa-play-circle history-icon"></i>
            <div class="history-text">
              <span>Tập coi gần nhất:</span>
              <strong class="history-number">{{ lastEpisode - 1 }}</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Social Links Card -->
      <div class="profile-card">
        <div class="card-header-green">
          <i class="fas fa-share-alt"></i>
          <span>Kết Nối Mạng Xã Hội</span>
        </div>
        <div class="card-body-white">
          <div class="social-icons-row">
            <a href="#" class="social-circle facebook-color">
              <i class="fab fa-facebook-f"></i>
            </a>
            <a href="#" class="social-circle twitter-color">
              <i class="fab fa-twitter"></i>
            </a>
            <a href="#" class="social-circle linkedin-color">
              <i class="fab fa-linkedin-in"></i>
            </a>
            <a href="#" class="social-circle youtube-color">
              <i class="fab fa-youtube"></i>
            </a>
          </div>
        </div>
      </div>
    </div>

    <ExploreModal ref="exploreModalRef" />
    <FollowingListModal ref="followingModalRef" />
    <ChatInboxModal ref="chatInboxModalRef" />
  </div>
</template>

<script setup>
import { storeToRefs } from 'pinia';
import { ref, onMounted, computed, watch, onBeforeUnmount } from 'vue';
import { useAuthStore } from '../../../stores/auth.js';
import { useMenuProfile } from '../../../stores/use-menu-profile.js';
import { useProfileStore } from '../../../stores/profile.js';
import { useGeneralStore } from '../../../stores/general';
import { useChatStore } from '../../../stores/chatStore.js';
import { useToast } from '../../../stores/useToast';
import api from '../../../services/axiosInterceptor.js';
import dayjs from 'dayjs';
import ExploreModal from '../../../components/ExploreModal.vue';
import FollowingListModal from '../../../components/FollowingListModal.vue';
import ChatInboxModal from '../../../components/ChatInboxModal.vue';

const toast = useToast();
const chatInboxModalRef = ref(null);
const chatStore = useChatStore();
const exploreModalRef = ref(null);
const followingModalRef = ref(null);

const openChatInbox = () => chatInboxModalRef.value.openModal();
const openExploreModal = () => exploreModalRef.value.openModal();
const openFollowingModal = () => followingModalRef.value.openModal();

const authStore = useAuthStore();
const useGeneral = useGeneralStore();
const useProfile = useProfileStore();
const { cover_position } = storeToRefs(useProfile);
const { isCropperModal, avatarUpdated } = storeToRefs(useGeneral);

const id = authStore.user?.id;
const { users, avatarUrl, coverUrl } = storeToRefs(useProfile);

const handleCameraClick = () => {
  isCropperModal.value = true;
};

const formattedBirthday = computed(() => {
  if (users.value.birthday) {
    return dayjs(users.value.birthday).format('DD-MM');
  }
  return '';
});

const fetchProfile = async () => {
  await useProfile.getProfile(id);
};

watch(
  () => avatarUpdated.value,
  (newValue) => {
    if (newValue) {
      useProfile.updateAvatarUrl(`${useProfile.avatarUrl}`);
      useGeneral.setAvatarUpdated(false);
    }
  }
);

const uploadHeaders = { Authorization: `Bearer ${authStore.accessToken}` };

const dragging = ref(false);
let startY = 0;
let originalCoverPosition = 0;

const coverStyle = computed(() => ({
  transform: `translateY(${cover_position.value}px)`,
}));

const coverPosition = computed({
  get() {
    return cover_position.value;
  },
  set(value) {
    cover_position.value = value;
    coverStyle.value.transform = `translateY(${cover_position.value}px)`;
  },
});

const onKeyDown = (event) => {
  if (event.key === 'Escape' && dragging.value) cancelDrag();
};

const startDrag = (event) => {
  dragging.value = true;
  startY = event.clientY;
  originalCoverPosition = cover_position.value;
  window.addEventListener('mousemove', onDrag);
  window.addEventListener('mouseup', stopDrag);
  window.addEventListener('keydown', onKeyDown);
};

const onDrag = (event) => {
  if (!dragging.value) return;
  const currentY = event.clientY;
  const deltaY = currentY - startY;
  startY = currentY;
  cover_position.value += deltaY;
  coverStyle.value.transform = `translateY(${cover_position.value}px)`;
};

const stopDrag = () => {
  dragging.value = false;
  window.removeEventListener('mousemove', onDrag);
  window.removeEventListener('mouseup', stopDrag);
  window.removeEventListener('keydown', onKeyDown);
};

const cancelDrag = () => {
  users.cover_position = originalCoverPosition;
  coverStyle.value.transform = `translateY(${users.cover_position}px)`;
  stopDrag();
  toast.info('Thao tác kéo đã bị hủy và vị trí đã được khôi phục.');
};

const newCoverFile = ref(null);
const newCoverUrl = ref(null);

const handleCoverUpload = (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    newCoverUrl.value = e.target.result;
  };
  newCoverFile.value = file;
  reader.readAsDataURL(file);
};

const saveNewCover = () => {
  if (!newCoverFile.value) {
    toast.error('Vui lòng chọn một tệp hình ảnh!');
    return;
  }
  const formData = new FormData();
  formData.append('file', newCoverFile.value);
  formData.append('position', cover_position.value);
  api
    .post(`link/upload/cover`, formData, {
      headers: { ...uploadHeaders, 'Content-Type': 'multipart/form-data' },
    })
    .then((response) => {
      if (response.status === 200) {
        useProfile.updateCoverPosition(response.data.positionY);
        useProfile.updateCoverUrl(response.data.url);
        showChange.value = false;
        toast.success('Cover đã được lưu thành công!');
      }
    })
    .catch(() => toast.error('Lưu hình cover thất bại!'));
};

const cancelChange = () => {
  showChange.value = false;
  newCoverUrl.value = null;
  toast.info('Đã hủy thao tác thay đổi hình cover.');
};

const cancelEdit = () => {
  showEdit.value = false;
  cover_position.value = originalCoverPosition;
  toast.info('Đã hủy thao tác chỉnh sửa hình cover.');
};

const showViewModal = ref(false);
const showChange = ref(false);
const showEdit = ref(false);

const handleSelect = (key) => {
  if (key === 'viewcover') showViewModal.value = true;
  else if (key === 'changecover') {
    showChange.value = true;
    showEdit.value = false;
  } else if (key === 'settingcover') {
    showEdit.value = true;
    showChange.value = false;
  }
};

const saveEditedCover = () => {
  api
    .patch(
      `link/update/cover-position`,
      { position: cover_position.value },
      { headers: uploadHeaders }
    )
    .then((response) => {
      if (response.status === 200) {
        useProfile.updateCoverPosition(response.data.positionY);
        showEdit.value = false;
        toast.success('Vị trí cover đã được lưu thành công!');
      }
    })
    .catch(() => toast.error('Lưu vị trí cover thất bại!'));
};

const lastChapter = ref('');
const lastEpisode = ref('');
const followStats = ref(null);

const getLastChapter = () => {
  api
    .get(`/story/user-chapter`)
    .then((r) => (lastChapter.value = r.data.chapter_id))
    .catch(console.error);
};

const getlastEpisode = () => {
  api
    .get(`/videos/user-episode`)
    .then((r) => (lastEpisode.value = r.data.episode_id))
    .catch(console.error);
};

const getFollowStats = async (userId) => {
  try {
    const response = await api.get(`/social/follow-stats/${userId}`);
    followStats.value = response.data;
  } catch (error) {
    console.error('Lỗi khi lấy thống kê follow:', error);
  }
};

onMounted(() => {
  useMenuProfile().onSelectedKey(['profile-info']);
  fetchProfile();
  getFollowStats(id);
  getLastChapter();
  getlastEpisode();
});

onBeforeUnmount(() => {
  window.removeEventListener('mousemove', onDrag);
  window.removeEventListener('mouseup', stopDrag);
  window.removeEventListener('keydown', onKeyDown);
});
</script>